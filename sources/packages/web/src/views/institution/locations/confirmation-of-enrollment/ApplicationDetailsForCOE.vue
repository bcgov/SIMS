<template>
  <div class="p-m-4">
    <HeaderNavigator
      title="Back to Programs"
      :routeLocation="{ name: InstitutionRoutesConst.COE_SUMMARY }"
      subTitle="View Financial Aid Application"
      ><template #buttons>
        <v-btn color="primary" @click="toggle"
          ><v-icon size="25">mdi-arrow-down-bold-circle</v-icon>Application
          Actions
        </v-btn>
      </template>
    </HeaderNavigator>
    <Menu class="mt-n15" ref="menu" :model="items" :popup="true" />
    <v-container>
      <Information :data="initialData" />
      <formio formName="confirmsstudentenrollment" :data="initialData"></formio>
    </v-container>
    <ConfirmCOE
      :showModal="showModal"
      :disbursementScheduleId="disbursementScheduleId"
      :locationId="initialData.applicationLocationId"
      @showHideConfirmCOE="showHideConfirmCOE"
      @reloadData="loadInitialData"
    />
    <ConfirmCOEEditModal ref="editCOEModal" />
    <ConfirmCOEDenyModal ref="denyCOEModal" @submitData="submitCOEDeny" />
  </div>
</template>
<script lang="ts">
import { useRouter } from "vue-router";
import { onMounted, ref, watch } from "vue";
import { InstitutionRoutesConst } from "@/constants/routes/RouteConstants";
import formio from "@/components/generic/formio.vue";
import { ConfirmationOfEnrollmentService } from "@/services/ConfirmationOfEnrollmentService";
import Menu from "primevue/menu";
import {
  COEStatus,
  ApplicationDetailsForCOEDTO,
  DenyConfirmationOfEnrollment,
  ProgramInfoStatus,
} from "@/types";
import ConfirmCOE from "@/components/institutions/confirmation-of-enrollment/modals/ConfirmCOEModal.vue";
import ConfirmCOEEditModal from "@/components/institutions/confirmation-of-enrollment/modals/ConfirmCOEEditModal.vue";
import ConfirmCOEDenyModal from "@/components/institutions/confirmation-of-enrollment/modals/ConfirmCOEDenyModal.vue";
import { useToastMessage, ModalDialog } from "@/composables";
import Information from "@/components/institutions/confirmation-of-enrollment/information.vue";
import HeaderNavigator from "@/components/generic/HeaderNavigator.vue";
/**
 * added MenuType interface for prime vue component menu,
 *  remove it when vuetify componnt is used
 */

export interface MenuType {
  label?: string;
  icon?: string;
  separator?: boolean;
  command?: any;
  class?: string;
}

export default {
  components: {
    formio,
    Menu,
    ConfirmCOE,
    ConfirmCOEEditModal,
    ConfirmCOEDenyModal,
    Information,
    HeaderNavigator,
  },
  props: {
    disbursementScheduleId: {
      type: Number,
      required: true,
    },
    locationId: {
      type: Number,
      required: true,
    },
  },
  setup(props: any) {
    const router = useRouter();
    const toast = useToastMessage();
    const initialData = ref({} as ApplicationDetailsForCOEDTO);
    const menu = ref();
    const items = ref([] as MenuType[]);
    const showModal = ref(false);
    const editCOEModal = ref({} as ModalDialog<boolean>);
    const denyCOEModal = ref({} as ModalDialog<void>);
    const showHideConfirmCOE = () => {
      showModal.value = !showModal.value;
    };

    const loadInitialData = async () => {
      initialData.value = await ConfirmationOfEnrollmentService.shared.getApplicationForCOE(
        props.disbursementScheduleId,
        props.locationId,
      );
    };

    const editProgramInformation = async () => {
      if (await editCOEModal.value.showModal()) {
        try {
          await ConfirmationOfEnrollmentService.shared.rollbackCOE(
            props.locationId,
            props.disbursementScheduleId,
          );
          toast.success(
            "Edit Program Information",
            "Program Information Request is now available to be edited.",
          );
          router.push({
            name: InstitutionRoutesConst.COE_SUMMARY,
          });
        } catch {
          toast.error(
            "Unexpected error",
            "An error happened while updating Confirmation of Enrollment.",
          );
        }
      }
    };
    const submitCOEDeny = async (
      submissionData: DenyConfirmationOfEnrollment,
    ) => {
      try {
        await ConfirmationOfEnrollmentService.shared.denyConfirmationOfEnrollment(
          props.locationId,
          props.disbursementScheduleId,
          submissionData,
        );
        toast.success("COE is Denied", "Application Status Has Been Updated.");
        router.push({
          name: InstitutionRoutesConst.COE_SUMMARY,
        });
      } catch {
        toast.error(
          "Unexpected error",
          "An error happened while denying Confirmation of Enrollment.",
        );
      }
    };
    const denyProgramInformation = async () => {
      await denyCOEModal.value.showModal();
    };
    const loadMenu = () => {
      items.value = [
        {
          label: "Confirm Enrollment",
          class:
            COEStatus.required === initialData.value.applicationCOEStatus &&
            !initialData.value.applicationWithinCOEWindow
              ? "text-muted"
              : "font-weight-bold",
          command: () => {
            if (
              COEStatus.required === initialData.value.applicationCOEStatus &&
              initialData.value.applicationWithinCOEWindow
            ) {
              showHideConfirmCOE();
            }
          },
        },
        { separator: true },
        {
          label: "Decline Request",
          class: "font-weight-bold",
          command: denyProgramInformation,
        },
      ];

      if (
        ProgramInfoStatus.notRequired !== initialData.value.applicationPIRStatus
      ) {
        items.value.push({ separator: true });
        items.value.push({
          label: "Edit Program Information",
          class: "font-weight-bold",
          command: editProgramInformation,
        });
      }
    };

    watch(
      () => initialData.value,
      () => {
        //update the list
        loadMenu();
      },
    );

    onMounted(async () => {
      loadMenu();
      await loadInitialData();
    });

    const toggle = (event: any) => {
      menu?.value?.toggle(event);
    };
    return {
      toggle,
      initialData,
      menu,
      items,
      COEStatus,
      showHideConfirmCOE,
      showModal,
      loadInitialData,
      editCOEModal,
      denyCOEModal,
      submitCOEDeny,
      InstitutionRoutesConst,
    };
  },
};
</script>
