<template>
  <full-page-container layout-template="centered">
    <template #header>
      <header-navigator
        title="Application history"
        :route-location="{
          name: AESTRoutesConst.STUDENT_APPLICATIONS,
          params: { studentId },
        }"
        sub-title="Assessments"
      />
      <application-header-title :application-id="applicationId" />
    </template>
    <request-assessment
      class="mb-5"
      :application-id="applicationId"
      @view-student-appeal="goToStudentAppeal"
      @view-student-application-offering-change="
        goToStudentApplicationOfferingChangeRequest
      "
      @view-application-exception="goToApplicationException"
      @view-offering-request="goToOfferingRequest"
    />
    <manual-reassessment
      class="mb-5"
      :application-id="applicationId"
      @reassessment-triggered="reloadHistory"
    />
    <history-assessment
      class="mb-5"
      :application-id="applicationId"
      :view-request-types="assessmentRequestTypes"
      @view-student-appeal="goToStudentAppeal"
      @view-student-application-offering-change="
        goToStudentApplicationOfferingChangeRequest
      "
      @view-assessment="gotToViewAssessment"
      @view-offering-request="goToOfferingRequest"
      @view-application-exception="goToApplicationException"
      @view-scholastic-standing-change="goToScholasticStanding"
      :key="historyKey"
    />
  </full-page-container>
</template>

<script lang="ts">
import { AESTRoutesConst } from "@/constants/routes/RouteConstants";
import { useRouter } from "vue-router";
import { defineComponent, ref } from "vue";
import { AssessmentTriggerType } from "@/types";
import RequestAssessment from "@/components/common/students/assessment/Request.vue";
import HistoryAssessment from "@/components/common/students/assessment/History.vue";
import ManualReassessment from "@/components/aest/students/assessment/ManualReassessment.vue";
import ApplicationHeaderTitle from "@/components/aest/students/ApplicationHeaderTitle.vue";

export default defineComponent({
  components: {
    RequestAssessment,
    HistoryAssessment,
    ManualReassessment,
    ApplicationHeaderTitle,
  },
  props: {
    studentId: {
      type: Number,
      required: true,
    },
    applicationId: {
      type: Number,
      required: true,
    },
  },
  setup(props) {
    const router = useRouter();
    const historyKey = ref(0);

    // The assessment trigger types for which the request form must be visible by default.
    const assessmentRequestTypes = [
      AssessmentTriggerType.StudentAppeal,
      AssessmentTriggerType.OfferingChange,
      AssessmentTriggerType.ScholasticStandingChange,
      AssessmentTriggerType.OriginalAssessment,
      AssessmentTriggerType.ApplicationOfferingChange,
    ];

    const goToStudentAppeal = (appealId: number) => {
      router.push({
        name: AESTRoutesConst.STUDENT_APPLICATION_APPEAL_REQUESTS_APPROVAL,
        params: {
          studentId: props.studentId,
          applicationId: props.applicationId,
          appealId,
        },
      });
    };

    const goToApplicationException = (exceptionId: number) => {
      router.push({
        name: AESTRoutesConst.APPLICATION_EXCEPTIONS_APPROVAL,
        params: {
          studentId: props.studentId,
          applicationId: props.applicationId,
          exceptionId,
        },
      });
    };

    const gotToViewAssessment = (assessmentId: number) => {
      router.push({
        name: AESTRoutesConst.ASSESSMENT_AWARD_VIEW,
        params: {
          studentId: props.studentId,
          applicationId: props.applicationId,
          assessmentId,
        },
      });
    };

    const goToScholasticStanding = (scholasticStandingId: number) => {
      router.push({
        name: AESTRoutesConst.SCHOLASTIC_STANDING_VIEW,
        params: {
          studentId: props.studentId,
          applicationId: props.applicationId,
          scholasticStandingId,
        },
      });
    };
    const goToOfferingRequest = (offeringId: number, programId: number) => {
      router.push({
        name: AESTRoutesConst.OFFERING_CHANGE_REQUEST_VIEW,
        params: {
          offeringId,
          programId,
        },
      });
    };
    const goToStudentApplicationOfferingChangeRequest = (
      applicationOfferingChangeRequestId: number,
    ) => {
      router.push({
        name: AESTRoutesConst.STUDENT_APPLICATION_OFFERING_CHANGE_REQUEST,
        params: {
          applicationOfferingChangeRequestId,
          applicationId: props.applicationId,
          studentId: props.studentId,
        },
      });
    };

    const reloadHistory = () => {
      // Changing component's key makes it to re-render/reload.
      historyKey.value++;
    };

    return {
      AESTRoutesConst,
      goToStudentAppeal,
      gotToViewAssessment,
      goToApplicationException,
      goToScholasticStanding,
      goToOfferingRequest,
      assessmentRequestTypes,
      goToStudentApplicationOfferingChangeRequest,
      historyKey,
      reloadHistory,
    };
  },
});
</script>
