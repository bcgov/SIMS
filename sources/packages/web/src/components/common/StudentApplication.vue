<template>
  <formio
    :formName="selectedForm"
    :data="initialData"
    :readOnly="isReadOnly"
    @loaded="formLoaded"
    @changed="formChanged"
    @submitted="submitted"
    @customEvent="customEvent"
  ></formio>
  <footer-buttons
    justify="space-between"
    :processing="processing"
    @primaryClick="wizardGoNext"
    @secondaryClick="wizardGoPrevious"
    :showPrimaryButton="!isLastPage"
    :showSecondaryButton="!isFirstPage"
    :primaryLabel="!isFirstPage ? 'Next section' : 'Start your application'"
    secondaryLabel="Previous section"
    class="mx-0"
  >
  </footer-buttons>
</template>

<script lang="ts">
import {
  OfferingIntensity,
  WizardNavigationEvent,
  FormIOCustomEvent,
  FormIOForm,
} from "@/types";
import { ref, watch, defineComponent } from "vue";
import {
  useFormioComponentLoader,
  useFormioDropdownLoader,
  useFormioUtils,
} from "@/composables";

export default defineComponent({
  emits: [
    "formLoadedCallback",
    "submitApplication",
    "customEventCallback",
    "pageChanged",
  ],
  props: {
    initialData: {
      type: Object,
      required: true,
    },
    selectedForm: {
      type: String,
      required: true,
    },
    isReadOnly: {
      type: Boolean,
      required: true,
    },
    programYearId: {
      type: Number,
      required: true,
    },
    processing: {
      type: Boolean,
      required: false,
    },
  },
  setup(props, context) {
    // Component's names on Form.IO definition that will be manipulated.
    const LOCATIONS_DROPDOWN_KEY = "selectedLocation";
    const PROGRAMS_DROPDOWN_KEY = "selectedProgram";
    const OFFERINGS_DROPDOWN_KEY = "selectedOffering";
    const PROGRAM_INTENSITY_DROPDOWN_KEY = "howWillYouBeAttendingTheProgram";
    const SELECTED_OFFERING_START_DATE_KEY = "selectedOfferingDate";
    const SELECTED_OFFERING_END_DATE_KEY = "selectedOfferingEndDate";
    const SELECTED_PROGRAM_DESC_KEY = "selectedProgramDesc";
    const OFFERING_INTENSITY_KEY = "howWillYouBeAttendingTheProgram";
    const PROGRAM_NOT_LISTED = "myProgramNotListed";
    const OFFERING_NOT_LISTED = "myStudyPeriodIsntListed";
    let formInstance: any;
    const formioUtils = useFormioUtils();
    const formioDataLoader = useFormioDropdownLoader();
    const formioComponentLoader = useFormioComponentLoader();
    const isFirstPage = ref(true);
    const isLastPage = ref(false);
    const showNav = ref(false);

    const getSelectedId = (form: any) => {
      return formioUtils.getComponentValueByKey(form, LOCATIONS_DROPDOWN_KEY);
    };

    const loadFormDependencies = async () => {
      if (!props.isReadOnly && !!formInstance) {
        await formioDataLoader.loadLocations(
          formInstance,
          LOCATIONS_DROPDOWN_KEY,
        );
        await formioDataLoader.loadProgramIntensityDetails(
          formInstance,
          props.initialData.isFulltimeAllowed,
          PROGRAM_INTENSITY_DROPDOWN_KEY,
        );
        const selectedLocationId = getSelectedId(formInstance);

        if (selectedLocationId) {
          // when isReadOnly.value is true, then consider
          // both active and inactive program year.
          await formioDataLoader.loadProgramsForLocation(
            formInstance,
            +selectedLocationId,
            PROGRAMS_DROPDOWN_KEY,
            props.programYearId,
            props.isReadOnly,
          );
        }
        const selectedProgramId = formioUtils.getComponentValueByKey(
          formInstance,
          PROGRAMS_DROPDOWN_KEY,
        );
        const selectedIntensity: OfferingIntensity =
          formioUtils.getComponentValueByKey(
            formInstance,
            OFFERING_INTENSITY_KEY,
          );
        if (selectedProgramId && selectedIntensity) {
          await formioComponentLoader.loadProgramDesc(
            formInstance,
            selectedProgramId,
            SELECTED_PROGRAM_DESC_KEY,
          );
          // when isReadOnly.value is true, then consider
          // both active and inactive program year.
          await formioDataLoader.loadOfferingsForLocation(
            formInstance,
            selectedProgramId,
            selectedLocationId,
            OFFERINGS_DROPDOWN_KEY,
            props.programYearId,
            selectedIntensity,
            props.isReadOnly,
          );
        }
      }
    };
    const formLoaded = async (form: any) => {
      showNav.value = true;
      // Emit formLoadedCallback event to the parent, so that parent can
      // perform the parent specific logic inside parent on
      // form is loaded
      context.emit("formLoadedCallback", form);
      formInstance = form;
      // Disable internal submit button.
      formioUtils.disableWizardButtons(formInstance);
      formInstance.options.buttonSettings.showSubmit = false;
      // Handle the navigation using the breadcrumbs.
      formInstance.on("wizardPageSelected", (page: any, index: number) => {
        isFirstPage.value = index === 0;
        isLastPage.value = formInstance.isLastPage();
        // Event to set isInFirstPage, current page and isInLastPage to parent
        context.emit(
          "pageChanged",
          isFirstPage.value,
          formInstance.page,
          isLastPage.value,
        );
      });
      // Handle the navigation using next/prev buttons.
      const prevNextNavigation = (navigation: WizardNavigationEvent) => {
        isFirstPage.value = navigation.page === 0;
        isLastPage.value = formInstance.isLastPage();
        // Event to set isInFirstPage, current page and isInLastPage to parent
        context.emit(
          "pageChanged",
          isFirstPage.value,
          formInstance.page,
          isLastPage.value,
        );
      };
      formInstance.on("prevPage", prevNextNavigation);
      formInstance.on("nextPage", prevNextNavigation);
      await loadFormDependencies();
    };

    const getOfferingDetails = async (form: any, locationId: number) => {
      const selectedIntensity: OfferingIntensity =
        formioUtils.getComponentValueByKey(form, OFFERING_INTENSITY_KEY);
      const educationProgramIdFromForm: number =
        formioUtils.getComponentValueByKey(form, PROGRAMS_DROPDOWN_KEY);
      if (educationProgramIdFromForm && selectedIntensity) {
        // when isReadOnly.value is true, then consider
        // both active and inactive program year.
        await formioDataLoader.loadOfferingsForLocation(
          form,
          educationProgramIdFromForm,
          locationId,
          OFFERINGS_DROPDOWN_KEY,
          props.programYearId,
          selectedIntensity,
          props.isReadOnly,
        );
      }
    };

    const formChanged = async (form: FormIOForm, event: any) => {
      const locationId = +formioUtils.getComponentValueByKey(
        form,
        LOCATIONS_DROPDOWN_KEY,
      );
      if (
        event.changed?.component.key === LOCATIONS_DROPDOWN_KEY ||
        event.changed?.component.key === OFFERING_INTENSITY_KEY
      ) {
        /*
        If `programnotListed` is already checked in the draft and
        when student edit the draft application and changes the
        location then `programnotListed` checkbox will reset/uncheck.
      */
        await formioUtils.resetCheckBox(form, PROGRAM_NOT_LISTED, {
          programnotListed: false,
        });
        const selectedLocationId = getSelectedId(form);

        if (selectedLocationId) {
          // when isReadOnly.value is true, then consider
          // both active and inactive program year.
          await formioDataLoader.loadProgramsForLocation(
            form,
            +selectedLocationId,
            PROGRAMS_DROPDOWN_KEY,
            props.programYearId,
            props.isReadOnly,
          );
        }
      }
      if (event.changed?.component.key === PROGRAMS_DROPDOWN_KEY) {
        if (+event.changed.value > 0) {
          await formioComponentLoader.loadProgramDesc(
            form,
            +event.changed.value,
            SELECTED_PROGRAM_DESC_KEY,
          );
        }

        /*
        If `offeringnotListed` is already checked in the draft and
        when student edit the draft application and changes the
        offering intensity then `programnotListed` checkbox will reset/uncheck.
      */
        await formioUtils.resetCheckBox(form, OFFERING_NOT_LISTED, {
          offeringnotListed: false,
        });
        await getOfferingDetails(form, locationId);
      }
      if (
        event.changed?.component.key === OFFERINGS_DROPDOWN_KEY &&
        +event.changed.value > 0
      ) {
        await formioComponentLoader.loadSelectedOfferingDetails(
          form,
          +event.changed.value,
          SELECTED_OFFERING_START_DATE_KEY,
          SELECTED_OFFERING_END_DATE_KEY,
        );
      }
      if (
        event.changed?.component.key === OFFERING_NOT_LISTED &&
        event.changed.value?.offeringnotListed
      ) {
        // If the user after selecting a study period finds that
        // they need to check my study period not listed, then
        // the details of previously selected
        // study period must be cleared.
        resetSelectedOfferingDetails(form);
      }

      // If the user after selecting a study period finds that
      // they need to check my program not listed, then
      // the details of previously selected
      // study period must be cleared.
      if (
        event.changed?.component.key === PROGRAM_NOT_LISTED &&
        event.changed.value?.programnotListed
      ) {
        resetSelectedOfferingDetails(form);
      }
    };

    const resetSelectedOfferingDetails = (form: FormIOForm) => {
      formioUtils.setComponentValue(form, SELECTED_OFFERING_END_DATE_KEY, "");
      formioUtils.setComponentValue(form, SELECTED_OFFERING_START_DATE_KEY, "");
    };

    const wizardGoPrevious = () => {
      formInstance.prevPage();
    };

    const wizardGoNext = () => {
      formInstance.nextPage();
    };

    const submitted = (args: any, form: any) => {
      context.emit("submitApplication", args, form);
    };

    const customEvent = (form: any, event: FormIOCustomEvent) => {
      context.emit("customEventCallback", form, event);
    };

    watch(
      () => props.initialData,
      async () => {
        await loadFormDependencies();
      },
    );
    return {
      wizardGoNext,
      wizardGoPrevious,
      formChanged,
      formLoaded,
      isFirstPage,
      isLastPage,
      submitted,
      customEvent,
      showNav,
    };
  },
});
</script>
