name: Prune Images
run-name: Pruning all but the most recent ${{ inputs.minTags }} tags prior to what is deployed in ${{ inputs.environment }}

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: 'Environment'
        required: true
        options:
          - dev
          - test
          - prod
        default: 'test'
      applications:
        description: 'Comma seperated list of applications to prune'
        required: true
        default: 'web-sims, api-sims, queue-consumers-sims, workers-sims'
      licensePlate:
        description: 'OpenShift License Plate'
        required: true
        default: '0c27fb'
      prefix:
        description: 'Branch prefix to restrict pruning to'
        required: false
        default: 'main'
      minTags:
        description: 'Minimum number of Tags to keep'
        required: false
        default: '10'
  schedule:
    - cron: '0 6 * * *' # Runs at 6 AM every day

jobs:
  prune-images:
    runs-on: ubuntu-latest
    steps:
      - name: Print env
        run: |
          echo "License Plate: ${{ inputs.licensePlate }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Applications: ${{ inputs.applications }}"
          echo "Prefix: ${{ inputs.prefix }}"
          echo "Minimum Tags: ${{ inputs.minTags }}"
      
      - name: Checkout source code
        uses: actions/checkout@v3
      
      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.SA_TOKEN }} --server=${{ vars.OPENSHIFT_CLUSTER_URL }}
      
      - name: Prune Images
        run: |
          pushd devops/scripts
          ./pruneImages.sh \
              --license_plate=${{ inputs.licensePlate }} \
              --env=${{ inputs.environment }} \
              --apps="${{ inputs.applications }}" \
              --prefix=${{ inputs.prefix }} \
              --min_tags=${{ inputs.minTags}}
          popd
    
          
